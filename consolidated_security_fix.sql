-- CONSOLIDATED SECURITY FIX (MASTER SCRIPT)
-- This script performs a FULL CLEANUP of policies and re-applies STRICT security.
-- It handles specific column naming ("userId", user_id, address).
-- It prevents "Policy already exists" errors by dropping everything first.

-- ==========================================================
-- 1. USER DATA TABLES (Strict Ownership)
-- ==========================================================

-- 1.1 USERS
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
-- Drop ALL potential previous policies
DROP POLICY IF EXISTS "Public_View_Users" ON public.users;
DROP POLICY IF EXISTS "Public_Insert_Users" ON public.users;
DROP POLICY IF EXISTS "Public_Update_Users" ON public.users;
DROP POLICY IF EXISTS "Strict_View_Users" ON public.users;
DROP POLICY IF EXISTS "Strict_Update_Self" ON public.users;
DROP POLICY IF EXISTS "Strict_Insert_Self" ON public.users;
DROP POLICY IF EXISTS "Users_Update_Self_Broad" ON public.users;
DROP POLICY IF EXISTS "Users can update their own profile" ON public.users;

-- Re-create Strict Policies
CREATE POLICY "Strict_View_Users" ON public.users FOR SELECT USING (true);
CREATE POLICY "Strict_Update_Self" ON public.users FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Strict_Insert_Self" ON public.users FOR INSERT WITH CHECK (auth.uid() = id);


-- 1.2 TODOS (Column: "userId")
ALTER TABLE public.todos ENABLE ROW LEVEL SECURITY;
-- Drop
DROP POLICY IF EXISTS "Public_All_Todos" ON public.todos;
DROP POLICY IF EXISTS "Strict_Select_Todos" ON public.todos;
DROP POLICY IF EXISTS "Strict_Insert_Todos" ON public.todos;
DROP POLICY IF EXISTS "Strict_Update_Todos" ON public.todos;
DROP POLICY IF EXISTS "Strict_Delete_Todos" ON public.todos;
DROP POLICY IF EXISTS "Allows all" ON public.todos;
DROP POLICY IF EXISTS "Users can manage their own todos" ON public.todos;

-- Create
-- Allow Public View for now to ensure UI works, or restrict later if needed.
CREATE POLICY "Strict_Select_Todos" ON public.todos FOR SELECT USING (true);
CREATE POLICY "Strict_Insert_Todos" ON public.todos FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Strict_Update_Todos" ON public.todos FOR UPDATE USING (auth.uid()::text = "userId"::text OR (SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Strict_Delete_Todos" ON public.todos FOR DELETE USING (auth.uid()::text = "userId"::text OR (SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');


-- 1.3 USER_CLAIMS (Column: user_id)
ALTER TABLE public.user_claims ENABLE ROW LEVEL SECURITY;
-- Drop
DROP POLICY IF EXISTS "Public_All_Claims" ON public.user_claims;
DROP POLICY IF EXISTS "Strict_Select_Claims" ON public.user_claims;
DROP POLICY IF EXISTS "Strict_Insert_Claims" ON public.user_claims;
DROP POLICY IF EXISTS "Strict_Update_Claims" ON public.user_claims;
DROP POLICY IF EXISTS "Strict_Delete_Claims" ON public.user_claims;
DROP POLICY IF EXISTS "Nuclear Allow All Claims" ON public.user_claims;

-- Create
CREATE POLICY "Strict_Select_Claims" ON public.user_claims FOR SELECT USING (true);
CREATE POLICY "Strict_Insert_Claims" ON public.user_claims FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Strict_Update_Claims" ON public.user_claims FOR UPDATE USING (auth.uid() = user_id);
-- Add Delete support just in case
CREATE POLICY "Strict_Delete_Claims" ON public.user_claims FOR DELETE USING (auth.uid() = user_id);


-- 1.4 COMMENTS (Column: address)
ALTER TABLE public.comments ENABLE ROW LEVEL SECURITY;
-- Drop
DROP POLICY IF EXISTS "Public_All_Comments" ON public.comments;
DROP POLICY IF EXISTS "Strict_Select_Comments" ON public.comments;
DROP POLICY IF EXISTS "Strict_Insert_Comments" ON public.comments;
DROP POLICY IF EXISTS "Strict_Delete_Comments" ON public.comments;

-- Create
CREATE POLICY "Strict_Select_Comments" ON public.comments FOR SELECT USING (true);
CREATE POLICY "Strict_Insert_Comments" ON public.comments FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Strict_Delete_Comments" ON public.comments FOR DELETE USING (
  address = (SELECT address FROM public.users WHERE id = auth.uid()) 
  OR (SELECT role FROM public.users WHERE id = auth.uid()) = 'admin'
);


-- 1.5 INBOX (Column: "userId")
ALTER TABLE public.inbox_messages ENABLE ROW LEVEL SECURITY;
-- Drop
DROP POLICY IF EXISTS "Public_All_Inbox" ON public.inbox_messages;
DROP POLICY IF EXISTS "Repair_Inbox_Select" ON public.inbox_messages;
DROP POLICY IF EXISTS "Strict_Select_Inbox" ON public.inbox_messages;
DROP POLICY IF EXISTS "Strict_Insert_Inbox" ON public.inbox_messages;

-- Create
CREATE POLICY "Strict_Select_Inbox" ON public.inbox_messages FOR SELECT USING (auth.uid()::text = "userId"::text);
-- System inserts messages, so we might need a Service Role override or just allow admins to insert?
-- Usually messages are generated by triggers/system. Service Role bypasses RLS.
-- But if Admin Panel sends messages manually:
CREATE POLICY "Strict_Insert_Inbox" ON public.inbox_messages FOR INSERT WITH CHECK ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');


-- ==========================================================
-- 2. ADMIN TABLES (Lock Down)
-- ==========================================================

-- 2.1 AIRDROPS
ALTER TABLE public.airdrops ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_Manage_Airdrops" ON public.airdrops;
DROP POLICY IF EXISTS "Public_View_Airdrops" ON public.airdrops;
DROP POLICY IF EXISTS "Strict_Manage_Airdrops" ON public.airdrops;

CREATE POLICY "Strict_Manage_Airdrops" ON public.airdrops FOR ALL 
USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin')
WITH CHECK ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Public_View_Airdrops" ON public.airdrops FOR SELECT USING (true);


-- 2.2 INVESTORS
ALTER TABLE public.investors ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_Manage_Investors" ON public.investors;
DROP POLICY IF EXISTS "Public_View_Investors" ON public.investors;
DROP POLICY IF EXISTS "Strict_Manage_Investors" ON public.investors;

CREATE POLICY "Strict_Manage_Investors" ON public.investors FOR ALL 
USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin')
WITH CHECK ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Public_View_Investors" ON public.investors FOR SELECT USING (true);


-- 2.3 ANNOUNCEMENTS
ALTER TABLE public.announcements ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_Manage_Announcements" ON public.announcements;
DROP POLICY IF EXISTS "Public_View_Announcements" ON public.announcements;
DROP POLICY IF EXISTS "Strict_Manage_Announcements" ON public.announcements;

CREATE POLICY "Strict_Manage_Announcements" ON public.announcements FOR ALL 
USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin')
WITH CHECK ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Public_View_Announcements" ON public.announcements FOR SELECT USING (true);


-- 2.4 CHAINS
ALTER TABLE public.chains ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_Manage_Chains" ON public.chains;
DROP POLICY IF EXISTS "Public_View_Chains" ON public.chains;
DROP POLICY IF EXISTS "Strict_Manage_Chains" ON public.chains;

CREATE POLICY "Strict_Manage_Chains" ON public.chains FOR ALL 
USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin')
WITH CHECK ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Public_View_Chains" ON public.chains FOR SELECT USING (true);


-- 2.5 INFOFI_PLATFORMS
ALTER TABLE public.infofi_platforms ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_Manage_InfoFi" ON public.infofi_platforms;
DROP POLICY IF EXISTS "Public_View_InfoFi" ON public.infofi_platforms;
DROP POLICY IF EXISTS "Strict_Manage_InfoFi" ON public.infofi_platforms;

CREATE POLICY "Strict_Manage_InfoFi" ON public.infofi_platforms FOR ALL 
USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin')
WITH CHECK ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Public_View_InfoFi" ON public.infofi_platforms FOR SELECT USING (true);


-- 2.6 ACTIVITIES
ALTER TABLE public.activities ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_Manage_Activities" ON public.activities;
DROP POLICY IF EXISTS "Public_View_Activities" ON public.activities;
DROP POLICY IF EXISTS "Strict_Manage_Activities" ON public.activities;

CREATE POLICY "Strict_Manage_Activities" ON public.activities FOR ALL 
USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin')
WITH CHECK ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Public_View_Activities" ON public.activities FOR SELECT USING (true);


-- 2.7 TOOLS
ALTER TABLE public.tools ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_Manage_Tools" ON public.tools;
DROP POLICY IF EXISTS "Public_View_Tools" ON public.tools;
DROP POLICY IF EXISTS "Strict_Manage_Tools" ON public.tools;

CREATE POLICY "Strict_Manage_Tools" ON public.tools FOR ALL 
USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin')
WITH CHECK ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Public_View_Tools" ON public.tools FOR SELECT USING (true);


-- 2.8 GLOBAL CLAIMS
ALTER TABLE public.claims ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_Manage_Global_Claims" ON public.claims;
DROP POLICY IF EXISTS "Public_View_Global_Claims" ON public.claims;
DROP POLICY IF EXISTS "Strict_Manage_Global_Claims" ON public.claims;

CREATE POLICY "Strict_Manage_Global_Claims" ON public.claims FOR ALL 
USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin')
WITH CHECK ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Public_View_Global_Claims" ON public.claims FOR SELECT USING (true);


-- 2.9 AIRDROP REQUESTS
ALTER TABLE public.airdrop_requests ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_Manage_Requests" ON public.airdrop_requests;
DROP POLICY IF EXISTS "Public_Submit_Requests" ON public.airdrop_requests;
DROP POLICY IF EXISTS "Strict_Manage_Requests" ON public.airdrop_requests;
DROP POLICY IF EXISTS "Strict_Update_Requests" ON public.airdrop_requests;
DROP POLICY IF EXISTS "Strict_Delete_Requests" ON public.airdrop_requests;

CREATE POLICY "Strict_Submit_Requests" ON public.airdrop_requests FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Strict_Manage_Requests" ON public.airdrop_requests FOR SELECT USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Strict_Update_Requests" ON public.airdrop_requests FOR UPDATE USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Strict_Delete_Requests" ON public.airdrop_requests FOR DELETE USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');


-- 2.10 GUIDES
ALTER TABLE public.guides ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_All_Guides" ON public.guides;
DROP POLICY IF EXISTS "Users can submit guides" ON public.guides;
DROP POLICY IF EXISTS "Allow_All_Auth_Guides" ON public.guides;
DROP POLICY IF EXISTS "Strict_Submit_Guides" ON public.guides;
DROP POLICY IF EXISTS "Public_View_Guides" ON public.guides;
DROP POLICY IF EXISTS "Strict_Manage_Guides" ON public.guides;
DROP POLICY IF EXISTS "Strict_Delete_Guides" ON public.guides;

CREATE POLICY "Strict_Submit_Guides" ON public.guides FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Public_View_Guides" ON public.guides FOR SELECT USING (true);
CREATE POLICY "Strict_Manage_Guides" ON public.guides FOR UPDATE USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Strict_Delete_Guides" ON public.guides FOR DELETE USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');


-- 2.11 CALENDAR EVENTS (Legacy support or alias for events)
ALTER TABLE public.calendar_events ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_All_Legacy_Calendar" ON public.calendar_events;
DROP POLICY IF EXISTS "Public_View_Legacy_Calendar" ON public.calendar_events;
DROP POLICY IF EXISTS "Strict_Manage_Legacy_Calendar" ON public.calendar_events;

CREATE POLICY "Strict_Manage_Legacy_Calendar" ON public.calendar_events FOR ALL 
USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin')
WITH CHECK ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Public_View_Legacy_Calendar" ON public.calendar_events FOR SELECT USING (true);


-- 2.10 MESSAGES
ALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_All_Messages" ON public.messages;
DROP POLICY IF EXISTS "Public_View_Messages" ON public.messages;
DROP POLICY IF EXISTS "Strict_Admin_Insert_Messages" ON public.messages;
DROP POLICY IF EXISTS "Strict_Admin_Update_Messages" ON public.messages;
DROP POLICY IF EXISTS "Admins can insert messages" ON public.messages;
DROP POLICY IF EXISTS "Nuclear Allow All Messages" ON public.messages;

CREATE POLICY "Strict_Admin_Insert_Messages" ON public.messages FOR INSERT WITH CHECK ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Strict_Admin_Update_Messages" ON public.messages FOR UPDATE USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Public_View_Messages" ON public.messages FOR SELECT USING (true);

-- 2.11 EVENTS
ALTER TABLE public.events ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_All_Events" ON public.events;
DROP POLICY IF EXISTS "Strict_Manage_Events" ON public.events;
DROP POLICY IF EXISTS "Public_View_Events" ON public.events;

CREATE POLICY "Strict_Manage_Events" ON public.events FOR ALL 
USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin')
WITH CHECK ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Public_View_Events" ON public.events FOR SELECT USING (true);


-- 2.12 ADMIN SECRETS (Strict)
ALTER TABLE public.admin_secrets ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public_Admin_Secrets" ON public.admin_secrets;
DROP POLICY IF EXISTS "Admins can view their own secrets" ON public.admin_secrets;
DROP POLICY IF EXISTS "Admins can manage secrets" ON public.admin_secrets;
DROP POLICY IF EXISTS "Strict_Admin_Secrets" ON public.admin_secrets;

CREATE POLICY "Strict_Admin_Secrets" ON public.admin_secrets FOR ALL 
USING ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin')
WITH CHECK ((SELECT role FROM public.users WHERE id = auth.uid()) = 'admin');

